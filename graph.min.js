/*! grapheditor - v0.0.0 - 2015-10-15
* Copyright (c) 2015 Filip Jelic (jelic.filip@gmail.com); Licensed MIT */
!function(a,b){"function"==typeof define&&define.amd?define([],b):"undefined"!=typeof module&&module.exports?module.exports=b():(console.log("Globals",a),a.Graph=b())}(this,function(){Raphael.fn.group=function(){function a(a,c){function d(a,b,c){var d="scale("+b+" "+c+")";return a?a.indexOf("scale(")<0?a+" "+d:a.replace(/scale\(-?[0-9]*?\.?[0-9]*?\ -?[0-9]*?\.?[0-9]*?\)/,d):d}function e(a,b){var c="rotate("+b+")";return a?a.indexOf("rotate(")<0?a+" "+c:a.replace(/rotate\(-?[0-9]+(\.[0-9][0-9]*)?\)/,c):c}function f(a,b,c){var d="translate("+b+" "+c+")";return a.indexOf("translate(")<0?a+" "+d:a.replace(/translate\(-?[0-9]*?\.?[0-9]*?\ -?[0-9]*?\.?[0-9]*?\)/,d)}var g,h=b.set(c),i=b.raphael.vml?document.createElement("group"):document.createElementNS("http://www.w3.org/2000/svg","g");return b.canvas.appendChild(i),g={scale:function(a,b){var c=i.getAttribute("transform")||"";return i.setAttribute("transform",d(c,a,b)),this},scaleAtPoint:function(a,b){this.getTranslation();this.scale(a,a)},getScale:function(){var a,b=/scale\((-?[0-9]*?\.?[0-9]*?)\ (-?[0-9]*?\.?[0-9]*?)\)/,c=i.getAttribute("transform"),d={};return c&&b.test(c)?(a=c.match(b),d.x=parseFloat(a[1]),d.y=parseFloat(a[2])):d={x:1,y:1},d},rotate:function(a){var b=i.getAttribute("transform")||"";i.setAttribute("transform",e(b,a))},push:function(a){function b(a){var c;if("set"===a.type)for(c=0;c<a.length;c++)b(a[c]);else"group"===a.type?(i.appendChild(a.node),h.push(a.set)):(i.appendChild(a.node),h.push(a))}return b(a),this},translate:function(a,b){var c=i.getAttribute("transform")||"";return i.setAttribute("transform",f(c,a,b)),this},setTranslation:function(a,b){return i.setAttribute("transform","translate("+a+" "+b+")"),this},getTranslation:function(){var a,b=/translate\((-?[0-9]*?\.?[0-9]*?)\ (-?[0-9]*?\.?[0-9]*?)\)/,c=i.getAttribute("transform"),d={};return c&&b.test(c)?(a=c.match(b),d.x=parseFloat(a[1]),d.y=parseFloat(a[2])):d={x:0,y:0},d},getBBox:function(){return h.getBBox()},getElementBBox:function(){return this.node.getBBox()},toFront:function(){return this.node.parentNode.appendChild(this.node),this},toBack:function(){return $(this.node.parentNode).prepend(this.node),this},drag:function(a,b,c,d,e,f){function g(b,c,e,f,g){a&&([].push.call(arguments,k),a.apply(d?d:this,arguments))}function i(a,c,d){var f=this.node.getCTM();k={x:f.e,y:f.f},b&&([].push.call(arguments,k),b.apply(e?e:this,arguments))}function j(a){k=null,c&&c.apply(f?f:this,arguments)}var k;h.forEach(function(a){"group"===a.type&&a.drag(g,i,j,this,this,this)}),h.drag(g,i,j,this,this,this)},hover:function(a,b,c,d){return c&&this.mouseover(a,c),d&&this.mouseout(b,d),c||d||$(this.node).hover(a,b),this},unhover:function(){return $(this.node).unbind("mouseover").unbind("mouseout"),this},mouseover:function(a,b){return b?$(this.node).mouseover(function(){a.apply(b,arguments)}):$(this.node).mouseover(a),this},mouseout:function(a,b){return b?$(this.node).mouseout(function(){a.apply(b,arguments)}):$(this.node).mouseout(a),this},mousedown:function(a,b){b=b||this,$(this.node).mousedown(function(){a.apply(b,arguments)})},mouseup:function(a,b){b=b||this,$(this.node).mouseup(function(){a.apply(b,arguments)})},unbindMouse:function(){return $(this.node).unbind("mousedown mouseup"),this},click:function(a,b){$(this.node).click(function(){a.apply(b?b:this,arguments)})},unclick:function(){return $(this.node).unbind("click"),this},keyup:function(a,b){b=b||this,$(this.node).bind("keypress",function(){a.apply(b,arguments)})},unkeyup:function(){return $(this.node).unbind("click"),this},remove:function(){$(this.node).unbind(),h.remove()},set:h,type:"group",node:i}}var b=this,c=arguments[0]instanceof Array?{}:arguments[0],d=arguments[0]instanceof Array?arguments[0]:arguments[1];return new a(c,d)},Raphael.fn.button=function(a,b){function c(a,b){function c(){var b,c,f=d.group();if(b=d.circle(0,0,a.radius),b.attr({fill:a.borderFill||"#EBEBEB",stroke:a.borderStroke||"#C8C8C8"}),c=d.circle(0,0,a.radius-a.border),c.attr({fill:a.fill,stroke:"none"}),"undefined"!=typeof a.image){var h,i,j,k,l,m;k=new Image,k.src=a.image.url,$(k).load(function(){f&&(console.log(k.width,k.height),l=a.image.width||k.width,m=a.image.height||k.height,h=-l/2,i=-m/2,j=d.image(a.image.url,h,i,l,m),f.push(j))})}f.push(b).push(c),f.translate(a.x,a.y),f.node.setAttribute("class","svg-buttons"),g=f,e()}function e(){b.onClick&&g.click(b.onClick,b.scope)}var f,g,h=b.onClick;return c(),f={remove:function(){h&&g.unclick(),g.remove()},translateX:function(a){g.setTranslation(a,g.getTranslation().y)},getEl:function(){return g}}}var d=this,e={};return a.border=a.border||4,e.onClick=b&&"function"==typeof b.onClick?b.onClick:null,e.scope="undefined"!=typeof b.scope?b.scope:this,new c(a,e)},Raphael.fn.curve=function(a,b){function c(a,b){function c(a){var c=g(a);k=d.path(c),k.attr({stroke:"#868686","stroke-width":b["stroke-width"]+1}).toBack(),j=d.path(c),j.attr(b),m.push(j).push(k)}function e(a){var b;return a.x1>a.x2&&a.y1>a.y2&&(b=a.x1,a.x1=a.x2,a.x2=b,b=a.y1,a.y1=a.y2,a.y2=b),a.y1<a.y2&&a.x1>a.x2&&(b=a.x1,a.x1=a.x2,a.x2=b,b=a.y1,a.y1=a.y2,a.y2=b),f=a,a}function g(a){var b,c,d,f,g;a=e(a),c=h(a),d="M"+a.x1+","+a.y1+" ",g="C"+c.x1+","+c.y1+" "+c.x2+","+c.y2+" ",f=a.x2+","+a.y2;var i=Math.floor(a.y1)===Math.floor(a.y2)?"L ":g;return b=d+i+f}function h(a){var b={},c=a.x1<a.x2?a.x2-a.x1:a.x1-a.x2;return b.x1=Math.floor(a.x1+c),b.y1=a.y1,b.x2=Math.floor(a.x2-c),b.y2=a.y2,b}var i,j,k,l,m=d.group();return c(a),i={redraw:function(a,b){var c=g(a);return k.attr({path:c,"stroke-width":b+1}).toBack(),j.attr({path:c,"stroke-width":b}),f.x2=a.x2,f.y2=a.y2,l&&(this.unGlow(),this.glow()),this},glow:function(a){var b={opacity:.3};if("object"==typeof a)for(var c in a)b[c]=a[c];return l||(l=k.glow(b)),this},unGlow:function(){l&&(l.remove(),l=null)},remove:function(){j&&k&&(j.remove(),k.remove(),m.remove())},mouseover:function(a,b){j.mouseover(a,b)},mouseout:function(a,b){m.mouseout(a,b)},click:function(a,b){b=b||this,m.click(a,b)},unclick:function(){m.unclick()},toBack:function(){j.toBack(),k.toBack(),m.toBack()},getPath:function(){return m},getNode:function(){return m.node},getPathInner:function(){return j},getPathOuter:function(){return k},getBBox:function(){return m.getBBox()},getEndPointCoords:function(){return f},push:function(a){return m.push(a)}}}var d=this,e={x1:0,x2:0,y1:0,y2:0};a=a||e,b=b||{};var f={x2:a.x2,y2:a.y2};return new c(a,b)};var a=({id:_.random(1e5,999999)+"",start_node:"",end_node:"",input_name:"",output_name:"",connection_name:""},{display:{canvas:{x:50,y:50,zoom:1},nodes:{}},nodes:[],schemas:{},relations:[]}),b=function(){var a={id:_.random(1e5,999999)+"",name:"Test node",inputs:[{id:_.random(1e5,999999)+"",name:"input"}],outputs:[{id:_.random(1e5,999999)+"",name:"output"}],properties:{}};return{get:function(b){var c=_.clone(a,!0);if("object"==typeof b)switch(b.type){case"square":c.nodeType="square";break;default:c.nodeType="circle"}return c.id=_.random(1e5,999999)+"",c.inputs[0].id=_.random(1e5,999999)+"",c.outputs[0].id=_.random(1e5,999999)+"",c.name=c.name+" "+c.id,c},set:function(b){var c=_.clone(a,!0);return c.id=_.random(1e5,999999)+"",c.inputs[0].id=_.random(1e5,999999)+"",c.outputs[0].id=_.random(1e5,999999)+"",c.name=c.name+" "+c.id,b.name&&(c.name=b.name),b.ubiquitousUnique&&(c.ubiquitousUnique=b.ubiquitousUnique),b.dataCategory&&(c.dataCategory=b.dataCategory),b.inputsName&&(c.inputs[0].name=b.inputsName),b.outputName&&(c.outputs[0].name=b.outputName),b.properties&&(c.properties=b.properties),"undefined"!=typeof b.hasParent&&(c.parent=b.hasParent),b.instance&&(c.instance=b.instance),b.propertyType&&(c.propertyType=b.propertyType),"undefined"!=typeof b.hasAsaNodeFilter&&(c.hasAsaNodeFilter=b.hasAsaNodeFilter),"undefined"!=typeof b.hasFilterInstances&&(c.hasFilterInstances=b.hasFilterInstances),"undefined"!=typeof b.filterInstances&&(c.filterInstances=b.filterInstances),b.selected&&(c.selected=b.selected),b.nodeType&&(c.nodeType=b.nodeType),c.childrenList||(c.childrenList=[]),c}}}(),c=(function(){var a={model:b.get(),children:[{model:b.get(),children:[{model:b.get(),children:[{model:b.get()},{model:b.get(),children:[{model:b.get()},{model:b.get(),children:[{model:b.get()},{model:b.get()}]}]}]},{model:b.get(),children:[{model:b.get(),children:[{model:b.get()},{model:b.get()}]},{model:b.get()}]},{model:b.get(),children:[{model:b.get()},{model:b.get()}]}]}]};return{get:function(){var c=_.clone(a,!0),d=[c],e=function(a){_.forEach(a,function(a){a.model=b.set({}),"undefined"!=typeof a.children&&_.isArray(a.children)&&a.children.length>0&&e(a.children)})};return e(d),c}}}(),function(a){this.nodeViews=a.nodes,this.model=a.model,this.canvas=a.canvas,this.parent=a.parent,this.element=a.element,this.Pipeline=a.pipeline,this.input=a.input,this.output=a.output,this.baseUrl=this.Pipeline.assetsUrl,this.id=this.model.id,h.checkObjectKeys(this.Pipeline.constraints.connection)&&h.setConstraints(this.constraints,this.Pipeline.constraints.connection),this._createConnection(this.input,this.output),this._attachEvents()});c.prototype={constraints:{baseUrl:"/",strokeWidth:7,strokeColor:"#FBFCFC",labelColor:"#8989FF",disableWire:!1,images:{wirePath:"preview_assets/images/wire-cut.png"}},_attachEvents:function(){var a,b,c,d=this,e=[];a=function(){d.draw()},b=function(){d.removeWire()},c=function(a){d.tempConnectionActive=a},this.Pipeline.editMode&&this.connection.mouseover(this.onMouseOver,this),this.Pipeline.Event.subscribe("connection:stroke:calculate",a),e.push({event:"connection:stroke:calculate",handler:a}),this.Pipeline.Event.subscribe("remove:wire",b),e.push({event:"remove:wire",handler:b}),this.Pipeline.Event.subscribe("temp:connection:state",c),e.push({event:"temp:connection:state",handler:c}),this.events=e},_getOffset:function(a){var b=document.body.getBoundingClientRect(),c=a.getBoundingClientRect(),d=c.top-b.top,e=c.left-b.left;return{top:d,left:e}},onMouseOver:function(a,b,c){if(!this.Pipeline.tempConnectionActive&&!this.constraints.disableWire){var d=this,e=this.constraints.images.wirePath,f=this._getOffset(this.element[0]);this.removeWire(),this.wire=this.canvas.image(this.constraints.baseUrl+e,b-f.left-15,c-f.top-15,25,25),this.wire.click(function(){d.removeWire(),d.destroyConnection()}),this.wire.mouseout(this.onMouseOut,this),this.startTime=Date.now()}},onMouseOut:function(){var a=this.startTime-Date.now();this.wire&&a>1e3?this.wire.remove():this.removeWire()},removeWire:function(){return this.wire&&(this.wire.unclick(),this.wire.remove()),this},draw:function(){var a,b,c=this.parent.getScale().x;a=this._getCoords(this.input,this.output),b=this.constraints.strokeWidth*c,this.connection.redraw(a,b);var d=this.connection.getPathInner().getTotalLength(),e=this.connection.getPathInner().getPointAtLength(d/2);return this.connectionLabel&&this.connectionLabel.attr({x:e.x,y:e.y}),this.removeWire(),this._glow?(console.log("Glow: ",this._glow),this.removeGlow(),this.glow()):this.removeGlow(),this},glow:function(){return this._glow=this.connection.getPathOuter().glow(),this.connection.push(this._glow),this._glow.toBack(),this},removeGlow:function(){return this._glow&&(this._glow.remove(),this._glow=null),this},_getCoords:function(a,b){var c=a.el.node.getCTM(),d=b.el.node.getCTM(),e=this.parent.getTranslation(),f=this.parent.getScale().x;return c.e=c.e/f,c.f=c.f/f,d.e=d.e/f,d.f=d.f/f,c.e-=e.x/f,c.f-=e.y/f,d.e-=e.x/f,d.f-=e.y/f,{x1:c.e,x2:d.e,y1:c.f,y2:d.f}},_createConnection:function(a,b){var c,d,e=this.parent.getScale().x;d=this._getCoords(a,b),c={stroke:this.constraints.strokeColor,"stroke-width":this.constraints.strokeWidth*e},this.connection=this.canvas.curve(d,c),this.parent.push(this.connection.getPath());var f=this.connection.getPathInner().getTotalLength(),g=this.connection.getPathInner().getPointAtLength(f/2);this.model.connection_name&&""!==this.model.connection_name&&(this.connectionLabel=this.canvas.text(g.x,g.y,this.model.connection_name).attr({fill:this.constraints.labelColor}),this.connection.push(this.connectionLabel)),this.connection.toBack(),a.addConnection(this.model.id),b.addConnection(this.model.id),a.setConnectedState(),b.setConnectedState(),a.terminals[b.model.id]=this.model.id,b.terminals[a.model.id]=this.model.id},destroyConnection:function(){var a,b;this.connection.remove(),this.Pipeline.nodes[this.model.start_node].removeConnection(this.model),this.Pipeline.nodes[this.model.end_node].removeConnection(this.model),a=this.input.removeConnection(this.model.id),b=this.output.removeConnection(this.model.id),this.input.terminals[this.output.model.id]=null,delete this.input.terminals[this.output.model.id],this.output.terminals[this.input.model.id]=null,delete this.output.terminals[this.input.model.id],this.connectionLabel&&this.connectionLabel.remove(),a||(this.input.terminalConnected=!1,this.input.setDefaultState()),b||(this.output.terminalConnected=!1,this.output.setDefaultState()),this.Pipeline.Event.trigger("connection:remove"),this.Pipeline.Event.trigger("connection:destroy"),this.Pipeline.Event.trigger("pipeline:change")},destroy:function(){var a=this;this.destroyConnection(),_.each(this.events,function(b){a.Pipeline.Event.unsubscribe(b.event,b.handler)})}};var d=function(){var a={radius:38,borderWidth:7,labelOffset:12,outdated:{fill:"#F5AB35",gradient:""},deleted:{fill:"red",gradient:""},selected:{fill:"#bb200a"},fill:"none",stroke:"#bb200a"},b={width:100,height:50,borderWidth:5,borderRadius:5,labelOffset:12,fill:"#011E37",stroke:"none"},c={input:"preview_assets/images/icon-input-2.png",output:"preview_assets/images/icon-output-2.png","default":"preview_assets/images/cloud.png"},d={radius:12,border:3,info:{fill:"#3FC380",disabled:"#ccc",image:{name:"preview_assets/images/icon-info.png",width:6,height:11}},"delete":{fill:"#EF4836",image:{name:"preview_assets/images/icon-delete.png",width:10,height:10}},rename:{fill:"transparent",image:{name:"preview_assets/images/icon-pencil.png",width:12,height:12}}},f=function(e){var f=_.clone(a,!0),g=_.clone(b,!0),i=_.clone(d,!0),j=_.clone(c,!0);this.options=e,this.canvas=e.canvas,this.parent=e.pipelineWrap,this.Pipeline=e.pipeline,this.baseUrl=this.Pipeline.assetsUrl,this.el=null,this.model=e.model,this.inputs=[],this.outputs=[],this.id=this.model.id,this.connections={},this.dragged=!1,this.selected=!1,this.inputRefs=this.model.inputs,this.outputRefs=this.model.outputs,this.constraints=f,this.icons=j,this.buttons=i,this.squareConstraints=g,h.checkObjectKeys(this.Pipeline.constraints.node)&&(h.setConstraints(this.constraints,this.Pipeline.constraints.node),h.setConstraints(this.squareConstraints,this.Pipeline.constraints.node)),h.checkObjectKeys(this.Pipeline.constraints.buttons)&&h.setConstraints(this.buttons,this.Pipeline.constraints.buttons),h.checkObjectKeys(this.Pipeline.constraints.icons)&&h.setConstraints(this.icons,this.Pipeline.constraints.icons),"object"==typeof e.constraints&&(this.constraints=_.extend({},this.constraints,e.constraints),this.squareConstraints=_.extend({},this.squareConstraints,this.constraints),this.icons=_.extend({},this.icons,this.constraints.icons)),"undefined"!=typeof e.display&&("object"==typeof e.display.constraints&&(this.constraints=_.extend(this.constraints,e.display.constraints)),"object"==typeof e.display.constraints&&(this.squareConstraints=_.extend(this.squareConstraints,e.display.squareConstraints)),"object"==typeof e.display.constraints&&(this.icons=_.extend(this.icons,e.display.icons)))};return f.prototype={getFirstTerminal:function(a){return this[a+"s"][0]},render:function(){var a,b;switch(this.model.nodeType){case"square":b=this.initSquareTerminals,a=this.renderSquare;break;default:b=this.initCircleTerminals,a=this.renderCircle}return b.call(this),a.call(this)},renderSquare:function(){var a,b,c,d,e,f,g,h,i=this,j=this.squareConstraints,k=this.model,l=this.canvas,m=j.labelOffset,n=this.inputs,o=this.outputs,p=j.borderRadius,q=j.borderWidth,r=j.width,s=j.height;a=l.group(),b=l.rect(-r/2,0,r,s,p),b.attr({fill:"#FBFCFC",stroke:"#dddddd"}),c=l.rect(q-r/2,q,r-2*q,s-2*q,p),c.attr({fill:j.fill,stroke:j.stroke}),d=l.group(),d.push(b).push(c);var t=k.label?k.label:k.name||k.id;return e=l.text(0,s+m,t),e.attr({"font-size":14}),a.push(d).push(e),_.forEach(n,function(b){a.push(b.render().el)}),_.forEach(o,function(b){a.push(b.render().el)}),a.translate(k.x,k.y),this.el=a,this.label=e,this._innerBorder=c,this._outerBorder=b,this.circle=d,this.icons["default"]===!1?i._attachEvents():(h=this.icons["default"],g=new Image,h=i.baseUrl+h,g.src=h,$(g).load(function(){f=l.image(h,-g.width/2,s/2-g.height/2,g.width,g.height),d.push(f),i._attachEvents()})),this},renderCircle:function(){var a,b,c,d,e,f,g,h,i=this,j=this.constraints,k=this.model,l=this.canvas,m=j.radius,n=j.borderWidth,o=j.labelOffset,p=this.inputs,q=this.outputs;a=l.group(),b=l.circle(0,0,m),b.attr({fill:"#FBFCFC",stroke:"#dddddd"}),c=l.circle(0,0,m-n),c.attr({fill:j.fill,stroke:j.stroke}),d=l.group(),d.push(b).push(c);var r=k.label?k.label:k.name||k.id;return e=l.text(0,m+o,k.softwareDescription&&k.softwareDescription.name?k.softwareDescription.name:r),e.attr({"font-size":14}),a.push(d).push(e),_.each(p,function(b){a.push(b.render().el)}),_.each(q,function(b){a.push(b.render().el)}),a.translate(k.x,k.y),this.el=a,this.label=e,this._innerBorder=c,this._outerBorder=b,this.circle=d,this.icons["default"]===!1?i._attachEvents():(h=this.icons["default"],"workflow"===k.type&&(h=this.icons.workflow),g=new Image,h=i.baseUrl+h,g.src=h,$(g).load(function(){f=l.image(h,-g.width/2,-g.height/2,g.width,g.height),d.push(f),i._attachEvents()})),this},initSquareTerminals:function(){var a,b,c=this.canvas,d=this.squareConstraints,f=this.inputs,g=this.outputs,h=this.inputRefs,i=this.outputRefs;a=_.extend({x:-d.width/2,y:d.height/2,input:!0},h[0]),f.push(new e({model:a,parent:this,canvas:c,pipeline:this.Pipeline,pipelineWrap:this.parent})),b=_.extend({x:d.width/2,y:d.height/2,input:!1},i[0]),g.push(new e({model:b,parent:this,canvas:c,pipeline:this.Pipeline,pipelineWrap:this.parent}))},initCircleTerminals:function(){var a,b,c,d,f=this.canvas,g=this.inputs,h=this.outputs,i=this.inputRefs,j=this.outputRefs,k=this.constraints.radius,l=120,m=-60,n=i.length,o=j.length;for(n>0&&(b=this._calculateTerminalAngles(n,l,k,!0)),a=0;n>a;a++)c=_.extend({x:b[a].x,y:b[a].y,input:!0},i[a]),g.push(new e({model:c,parent:this,canvas:f,pipeline:this.Pipeline,pipelineWrap:this.parent}));for(o>0&&(d=this._calculateTerminalAngles(o,m,k,!1)),a=0;o>a;a++)c=_.extend({x:d[a].x,y:d[a].y,input:!1},j[a]),h.push(new e({model:c,parent:this,canvas:f,pipeline:this.Pipeline,pipelineWrap:this.parent}))},_calculateTerminalAngles:function(a,b,c,d){var e,f,g,h,i,j=Math.floor,k=Math.sin,l=Math.cos,m=120,n=m/a,o=n/2,p=[];if(e=function(a){return a*Math.PI/180},d)for(;a--;)g=a*n,h=g+o+b,i=e(h),p.push({x:j(l(i)*c),y:j(k(i)*c)});else for(f=0;a>f;f++)g=f*n,h=g+o+b,i=e(h),p.push({x:j(l(i)*c),y:j(k(i)*c)});return p},_attachEvents:function(){var a=this,b=this.el,c=this.circle,d=this._outerBorder;c.mouseover(function(){b.toFront(),a.glow=d.glow({width:15,filled:!0,opacity:.3}).attr({stroke:"#9b9b9b"}),a.showTerminalNames()}),b.mouseout(function(){"undefined"!=typeof a.glow&&a.glow.remove(),a.hideTerminalNames()}),c.click(function(){var a=this.dragged;"undefined"==typeof a||a||(this.Pipeline.Event.trigger("node:deselect"),this.Pipeline.editMode?this._select():this._showInfo()),this.dragged=!1},this),c.drag(this.onMove,this.onMoveStart,this.onMoveEnd,this,this,this)},showTerminalNames:function(){var a=this.inputs,b=this.outputs;_.each(a,function(a){a.showTerminalName()}),_.each(b,function(a){a.showTerminalName()})},hideTerminalNames:function(){var a=this.inputs,b=this.outputs;_.each(a,function(a){a.hideTerminalName()}),_.each(b,function(a){a.hideTerminalName()})},onMoveStart:function(a,b,c,d){var e=this.parent,f=e.node.getCTM(),g=e.getScale();d.x-=f.e,d.y-=f.f,d.x=d.x/g.x,d.y=d.y/g.y},onMove:function(a,b,c,d,e,f){var g=this.parent,h=this.el,i=g.getScale();a/=i.x,b/=i.y,h.translate(f.x+a,f.y+b),this.redrawConnections(),this.dragged=!0,this.Pipeline.Event.trigger("scrollbars:draw"),this.Pipeline.Event.trigger("pipeline:change"),this.Pipeline.Event.trigger("node:drag",this.model,f.x+a,f.y+b)},onMoveEnd:function(){var a=this.el.getTranslation(),b=this.model;(b.x!==a.x||b.y!==a.y)&&(b.x=a.x,b.y=a.y,this.dragged&&this.Pipeline.Event.trigger("pipeline:change","display"))},getTerminalById:function(a,b){var c;return c=_.find(this[b+"s"],function(b){var c=b.model["@id"]||b.model.id;return c===a})},redrawConnections:function(){_.each(this.connections,function(a,b){a&&a.draw()})},addConnection:function(a){this.connections[a.id]=a},removeConnection:function(a){this.connections[a.id]&&(this.connections[a.id]=null,delete this.connections[a.id],this.Pipeline.removeConnection(a))},deselectAvailableTerminals:function(){_.each(this.inputs,function(a){a.setDefaultState()}),_.each(this.outputs,function(a){a.setDefaultState()})},_showButtons:function(){var a,b=this,c=this.constraints.radius;"square"===this.model.nodeType?(c=this.squareConstraints.height,a=-.5*c):a="undefined"!=typeof this.buttons.distance?-this.buttons.distance-c-this.buttons.radius:1.5*-c,this.infoButton||this.removeNodeButton||(this.buttons.rename.image.url=this.baseUrl+this.buttons.rename.image.name,this.infoButton=this.canvas.button({fill:this.buttons.info.fill,x:16,y:a,radius:this.buttons.radius,border:this.buttons.border,image:{url:this.baseUrl+this.buttons.info.image.name,width:14,height:14}},{onClick:this._showInfo,scope:this}),this.removeNodeButton=this.canvas.button({fill:this.buttons["delete"].fill,x:-16,y:a,radius:this.buttons.radius,border:this.buttons.border,image:{url:this.baseUrl+this.buttons["delete"].image.name,width:14,height:14}},{onClick:this._removeNodeButtonClick,scope:this}),b.el.push(b.infoButton.getEl()).push(b.removeNodeButton.getEl()))},_destroyButtons:function(){this.infoButton&&(this.infoButton.remove(),this.infoButton=null),this.removeNodeButton&&(this.removeNodeButton.remove(),this.removeNodeButton=null)},_removeNodeButtonClick:function(){this._destroyButtons(),this.Pipeline.removeNode(this.model.id)},_showInfo:function(){this.Pipeline.Event.trigger("node:showInfo",this.model)},_select:function(){this.Pipeline.editMode&&(this.Pipeline.selectedNodes.push(this),this._showButtons(),this._outerBorder.attr({fill:this.constraints.selected.fill}),this.selected=!0,this.Pipeline.Event.trigger("node:select",this.model))},_deselect:function(){this._destroyButtons(),this._outerBorder.attr({fill:"#ffffff"}),this.selected=!1,this.Pipeline.Event.trigger("node:deselected",this.model)},setStyle:function(a){return"object"!=typeof a?(console.error("Parameter has to be object, got: "+typeof a,a),!1):(this.constraints.selectedNewProp=a,void this._innerBorder.attr(a))},removeNode:function(){_.forEach(this.connections,function(a){a&&a.destroyConnection()}),_.forEach(this.inputs,function(a){a.destroy()}),_.forEach(this.outputs,function(a){a.destroy()}),this.connections={},"undefined"!=typeof this.glow&&this.glow.remove();var a=null,b=null;this.model.parent&&(a=this.model.parent,b=this.Pipeline.nodes[a].model),this.destroy(),delete this.Pipeline.model.schemas[this.model.id],delete this.Pipeline.nodes[this.model.id],this.Pipeline.Event.trigger("node:remove",this.model)},destroy:function(){this.circle.unbindMouse().unhover().unclick().unkeyup(),this.circle.remove(),this.el.remove()}},f}(),e=function(){var a={radius:8,radiusInner:4.4,available:{gradiant:"",fill:"#3eb157",stroke:""},connected:{gradiant:"",fill:"#1E8BC3",stroke:""},gradiant:"",fill:"#888888",stroke:""},b={width:7,color:"#dddddd"},c=function(c){this.options=c,this.parent=c.parent,this.model=c.model,this.canvas=c.canvas,this.mouseover=!1,this.terminalConnected=!1,this.Pipeline=c.pipeline,this.pipelineWrap=c.pipelineWrap,this.id=this.model.id,this.el=null,this.terminals={},this.connections=[],this.constraints=_.clone(a,!0),this.connectionConfig=_.clone(b,!0),h.checkObjectKeys(this.Pipeline.constraints.terminal)&&h.setConstraints(this.constraints,this.Pipeline.constraints.terminal),h.checkObjectKeys(this.Pipeline.constraints.connection)&&h.objectPropExists(this.Pipeline.constraints.connection.strokeWidth)&&(this.connectionConfig.width=this.Pipeline.constraints.connection.strokeWidth)};return c.prototype={initHandlers:function(){var a=this;this.mousedown=!1,this.Pipeline.editMode&&!this.Pipeline.disableConnectionCreation&&this.terminal.mousedown(function(b){var c;c=a._getElTranslation(),a.startCoords=c,a.mousedown=!0,a.Pipeline.Event.trigger("terminal:selectAvailable",a.model,a.parent.model.id),b.preventDefault(),b.stopPropagation()}),this.terminal.mouseup(function(){a.Pipeline.Event.trigger("terminal:deselectAvailable"),a._removeTempConnection(a.onMouseUpCallback),a.mousedown=!1});var b=function(b){a.mousedown&&a.tempConnection&&(a.mouseoverTerminal=b,a.Pipeline.mouseoverTerminal=b)},c=function(){a.mouseoverTerminal=null,a.Pipeline.mouseoverTerminal=null},d=function(b,c){a.checkAvailibility(b,c)},e=function(){a.setDefaultState()},f=[];this.Pipeline.Event.subscribe("terminal:mouseover",b),f.push({event:"terminal:mouseover",handler:b}),this.Pipeline.Event.subscribe("terminal:mouseout",c),f.push({event:"terminal:mouseout",handler:c}),this.Pipeline.Event.subscribe("terminal:selectAvailable",d),f.push({event:"terminal:selectAvailable",handler:d}),this.Pipeline.Event.subscribe("terminal:deselectAvailable",e),f.push({event:"terminal:deselectAvailable",handler:e}),this.events=f},onMouseUpCallback:function(){var a,b=this;b.mouseoverTerminal&&(a=this.checkAvailibility(this.mouseoverTerminal.model,this.mouseoverTerminal.parent.model.id),a.status?(b.Pipeline.Event.trigger("connection:create",b.mouseoverTerminal,b),b.mouseoverTerminal=null):console.error("Node cannot connect"))},checkAvailibility:function(a,b){var c=!1,d=this.parent.model,e=this.Pipeline.nodes[b].model,f=this.model.id,g=a.id;if(a.input!==this.model.input&&b!==this.parent.model.id){var h=_.filter(this.Pipeline.connections,function(a){var b,c,h=a.model,i=h.start_node===d.id&&h.end_node===e.id,j=h.input_name===g&&h.output_name===f;return b=h.start_node===e.id&&h.end_node===d.id,c=h.input_name===f&&h.output_name===g,i&&j||b&&c});0===h.length&&(this.showAvailableState(),c=!0)}return{status:c}},render:function(){var a,b,c,d,e,f,g=this,h=this.model,i=this.canvas,j=12,k=this.model.required?"(required)":"";return a=i.group(),b=i.circle(0,0,this.constraints.radius),b.attr({fill:this.model.required?"#f4d794":"90-#F4F4F4-#F4F4F4:50-#F4F4F4:50-#F4F4F4",stroke:this.model.required?"#cbac6f":"#cccccc"}),c=i.circle(0,0,this.constraints.radiusInner),c.attr({fill:this.constraints.fill,stroke:this.constraints.stroke}),d=i.text(0,0,h.name||h.id+" "+k),d.attr({"font-size":"12px"}),e=h.input?-1*(d.getBBox().width/2)-j:d.getBBox().width/2+j,d.translate(e,0),d.attr("fill","none"),f=i.group(),f.push(b).push(c),f.hover(function(){g.mouseover=!0,g.Pipeline.tempConnectionActive||g.showTerminalName(),g.Pipeline.Event.trigger("terminal:mouseover",g)},function(){g.mouseover=!1,g.hideTerminalName(),g.Pipeline.Event.trigger("terminal:mouseout")}),a.push(f).push(d),a.translate(h.x,h.y),this.el=a,this.terminal=f,this.label=d,this.terminalInner=c,this.terminalBorder=b,this.initHandlers(),this},showTerminalName:function(){this.label.attr("fill","#666")},hideTerminalName:function(){this.mouseover||this.label.attr("fill","none")},setConnectedState:function(){this.terminalConnected=!0,this.terminalInner.attr({gradient:this.constraints.connected.gradiant,fill:this.constraints.connected.fill,stroke:this.constraints.connected.stroke}),this.model.required&&this.terminalBorder.attr({fill:"90-#F4F4F4-#F4F4F4:50-#F4F4F4:50-#F4F4F4",stroke:"#cccccc"})},showAvailableState:function(){this.terminalInner.attr({gradient:"none",fill:this.constraints.available.fill,stroke:this.constraints.available.stroke})},setDefaultState:function(){this.terminalInner.attr({gradient:this.constraints.gradient,fill:this.constraints.fill,stroke:this.constraints.stroke}),this.model.required&&this.terminalBorder.attr({fill:"#f4d794",stroke:"#cbac6f"}),this.terminalConnected?this.setConnectedState():this.terminalConnected=!1},addConnection:function(a){this.connections.push(a)},_getElTranslation:function(){var a,b,c,d;return a=this.Pipeline.getEl().getScale(),c=this.parent.el.getTranslation(),d=this.Pipeline.pipelineWrap.getTranslation(),b=this.el.getTranslation(),b.x+=c.x,b.y+=c.y,b.x+=d.x/a.x,b.y+=d.y/a.y,b.x=b.x*a.x,b.y=b.y*a.y,b},_getConnectionCoordsDiff:function(a){var b,c={},d=this.terminal.node.getScreenCTM();return b=this._getElTranslation(),c.x=a.clientX-(d.e-b.x),c.y=a.clientY-(d.f-b.y),c},drawConnection:function(a){var b,c,d=this._getConnectionCoordsDiff(a),e=this.pipelineWrap.getScale().x;c={x1:this.startCoords.x,y1:this.startCoords.y,x2:d.x,y2:d.y},b={stroke:"#FBFCFC","stroke-width":this.connectionConfig.width*e},this.tempConnection=this.canvas.curve(c,b),this.tempConnection.toBack(),this.Pipeline.Event.trigger("temp:connection:state",!0)},redrawConnection:function(a){var b,c=this.pipelineWrap.getScale().x,d=this._getConnectionCoordsDiff(a);b={x1:this.startCoords.x,y1:this.startCoords.y,x2:d.x,y2:d.y},this.tempConnection.redraw(b,this.connectionConfig.width*c)},removeConnection:function(a){var b;return _.each(this.connections,function(c,d){c===a&&(b=d)}),delete this.terminals[this.connections[b]],this.connections.splice(b,1),0!==this.connections.length},_removeTempConnection:function(a){this.tempConnection&&(this.tempConnection.remove(),this.tempConnection=null,a&&"function"==typeof a&&a(),this.Pipeline.Event.trigger("temp:connection:state",!1))},changeTerminalName:function(a){this.model.name=a,this.label.attr("text",this.model.name)},destroy:function(){var a=this;_.each(this.events,function(b){a.Pipeline.Event.unsubscribe(b.event,b.handler)}),this.terminal.unbindMouse().unhover().unclick().unkeyup(),this.el.remove(),this.el=null,this.terminal=null,this.label=null,this.terminalInner=null,this.terminalBorder=null}},c}(),f={subscriptions:{},trigger:function(a,b){if("undefined"!=typeof this.subscriptions[a]&&this.subscriptions[a]instanceof Array)for(var c=0;c<this.subscriptions[a].length;c++){var d=this.subscriptions[a][c];if("function"==typeof d.handler){var e=Array.prototype.slice.call(arguments);e=e.slice(1,e.length),d.handler.apply(d.scope,e)}}},subscribe:function(a,b,c){c=c||this,this._checkSubscriptionParams(a,b,c),"undefined"==typeof this.subscriptions[a]&&(this.subscriptions[a]=[]),this._isSubscribed(a,b,c)||this.subscriptions[a].push({handler:b,scope:c})},unsubscribe:function(a,b){if("undefined"==typeof a)throw"Invalid parameter exception: No event name specified.";if("undefined"==typeof this.subscriptions[a]||!(this.subscriptions[a]instanceof Array))throw'Error: Subscription "'+a+"\" does't exist";if("undefined"==typeof b)delete this.subscriptions[a];else for(var c=0,d=this.subscriptions[a].length;d>c;c++)if(this.subscriptions[a][c].handler===b){this.subscriptions[a].splice(c,1),0===this.subscriptions[a].length&&delete this.subscriptions[a];break}},_checkSubscriptionParams:function(a,b,c){if("undefined"==typeof a)throw"Invalid parameter exception: No event name specified.";if("undefined"==typeof b)throw"Invalid parameter exception: No event handler specified.";if("undefined"==typeof c)throw"Invalid parameter exception: No event handler scope specified.";if("string"!=typeof a)throw"Invalid parameter exception: Event name must be a string."},_isSubscribed:function(a,b,c){for(var d=!1,e=0;e<this.subscriptions[a].length;e++){var f=this.subscriptions[a][e];f.handler===b&&f.scope===c&&(d=!0)}return d}},g=function(){var b="#B6B6B6",e=function(b){this.options=b,this.assetsUrl=b.assetsUrl,this.model=b.model||_.clone(a,!0),this.treeGraph=b.treeGraph||!1,b.TreeModel&&(this.treeGraph=!0,this._parseTreeGraphModel(b.TreeModel)),this.$parent=b.$parent,this.nodes={},this.connections={},this.constraints={},this.assetsUrl=b.assetsUrl||"/",this.Event=_.clone(f,!0),this.editMode=b.editMode,
this.disableConnectionCreation=b.disableConnectionCreation,this.selectedNodes=[],this.tempConnectionRefs=null,this.tempConnectionActive=!1,this.currentScale=this.model.display.canvas.zoom||1,"object"==typeof b.constraints&&Object.keys(b.constraints).length>0&&this._overrideConstraints(b.constraints),this._initCanvas(),this._attachEvents(),this._generateNodes(),this._generateConnections(),this._drawScrollbars()};return e.prototype={_overrideConstraints:function(a){h.checkObjectKeys(a.node)&&(this.constraints.node=a.node),h.checkObjectKeys(a.terminal)&&(this.constraints.terminal=a.terminal),h.checkObjectKeys(a.connection)&&(this.constraints.connection=a.connection),h.checkObjectKeys(a.buttons)&&(this.constraints.buttons=a.buttons),h.checkObjectKeys(a.icons)&&(this.constraints.icons=a.icons)},_attachEvents:function(){var a=this,b=this.$parent;this.Event.subscribe("temp:connection:state",function(b){a.tempConnectionActive=b}),this.Event.subscribe("scrollbars:draw",function(){a._drawScrollbars()}),this.Event.subscribe("pipeline:change",function(){}),this.Event.subscribe("node:add",function(b,c){var e=new d({pipeline:a,model:b,canvas:a.canvas,pipelineWrap:a.pipelineWrap,constraints:c});a.nodes[b.id]=e,a.pipelineWrap.push(e.render().el)}),this.Event.subscribe("node:deselect",function(){_.each(a.selectedNodes,function(a){a.selected&&a._deselect()})}),this.Event.subscribe("node:select",function(a){}),this.Event.subscribe("connection:create",function(b,c){var d=b.model.input?b:c,e=b.model.input?c:b;a.tempConnectionRefs={end:d,start:e};var f={id:_.random(1e5,999999)+"",start_node:e.parent.model.id,end_node:d.parent.model.id,input_name:d.id,output_name:e.id,connection_name:""};a.createConnection(f),a.Event.trigger("connection:add",f)}),b.mousemove(function(b){_.each(a.nodes,function(a){_.each(a.inputs,function(a){b.preventDefault(),a.mousedown&&(a.tempConnection?a.redrawConnection(b):a.drawConnection(b))}),_.each(a.outputs,function(a){b.preventDefault(),a.mousedown&&(a.tempConnection?a.redrawConnection(b):a.drawConnection(b))})})}),$("body").on("mouseup",function(b){_.each(a.nodes,function(a){_.each(a.inputs,function(a){a.parent.deselectAvailableTerminals(),a._removeTempConnection(),a.onMouseUpCallback(),a.mouseoverTerminal=null,a.mousedown=!1}),_.each(a.outputs,function(a){a.parent.deselectAvailableTerminals(),a._removeTempConnection(),a.onMouseUpCallback(),a.mouseoverTerminal=null,a.mousedown=!1})})})},_initCanvas:function(){var a=600,b=600,c=this.$parent,d={width:c[0].offsetWidth-10,height:c[0].offsetHeight||c[0].parentNode.offsetHeight};a=d.width||a,b=d.height||b,b>0&&(b-=10),this.canvas=new Raphael(this.$parent[0],a,b),this.pipelineWrap=this.canvas.group(),this._initCanvasPosition(),this._initRect(this.canvas,a,b),this._initCanvasMove()},_initCanvasPosition:function(){this._move(this.model.display.canvas)},_initRect:function(a,b,c){this.rect=a.rect(0,0,b,c),this.rect.dragged=!1,this.rect.attr({stroke:"none",fill:"#fff",opacity:"0"})},_initZoomLevel:function(a){this.getEl().scale(a,a),this._drawScrollbars()},_move:function(a){this.getEl().translate(a.x,a.y)},_initCanvasMove:function(){var a,b,c,d,e=this,f=this.getEl(),g=f.getScale();a=function(a,b,c){d=f.getTranslation(),d.x=d.x*g.x,d.y=d.y*g.y,e.Event.trigger("canvas:drag:start",d)},b=function(a,b){var c=d,h=0===Object.keys(e.nodes).length;h||(f.translate((c.x+a)/g.x,(c.y+b)/g.y),e.rect.dragged=!0,e._drawScrollbars(),e.Event.trigger("pipeline:change"),e.Event.trigger("canvas:drag:move",{x:(c.x+a)/g.x,y:(c.y+b)/g.y}))},c=function(){var a,b=_.clone(f.getTranslation(),!0);b.zoom=g.x,a=e.model.display.canvas,a.x=b.x,a.y=b.y,e.rect.dragged&&e.Event.trigger("canvas:drag:end",a),d={x:0,y:0}},this.rect.drag(b,a,c),this.rect.click(function(){e.rect.dragged||e.Event.trigger("node:deselect"),e.rect.dragged=!1}),this.rect.mouseover(function(){e.Event.trigger("remove:wire")})},_generateNodes:function(){var a=this;_.each(a.model.nodes,function(b,c){var e=b["@id"]||b.id,f=b;f.x=a.model.display.nodes[e].x,f.y=a.model.display.nodes[e].y,a.nodes[e]=new d({pipeline:a,model:f,canvas:a.canvas,pipelineWrap:a.pipelineWrap,display:a.model.display.nodes[e]})}),_.each(a.nodes,function(b){a.pipelineWrap.push(b.render().el)}),this.pipelineWrap.translate(this.model.display.canvas.x,this.model.display.canvas.y),this.rect.toBack()},_generateConnections:function(){var a=this;_.each(this.model.relations,function(b){a._createConnection(b)})},_createConnection:function(a){var b=this,d=b.nodes[a.start_node].getTerminalById(a.output_name,"output"),e=b.nodes[a.end_node].getTerminalById(a.input_name,"input");b.connections[a.id]=new c({model:a,canvas:b.canvas,parent:b.pipelineWrap,nodes:b.nodes,pipeline:b,input:d,output:e,element:b.$parent}),b.nodes[a.start_node].addConnection(b.connections[a.id]),b.nodes[a.end_node].addConnection(b.connections[a.id])},_generateNodeId:function(a){var b,c=!0,d=a.softwareDescription&&a.softwareDescription.label?a.softwareDescription.label:a.label||a.name,e=0;for("#"!==d.charAt(0)&&(d="#"+d);c;)c=0===e?this._checkIdAvailable(d):this._checkIdAvailable(d+"_"+e),e=c?e+1:e;return b=0===e?d:d+"_"+e},_checkIdAvailable:function(a){return!!this.nodes[a]},_markCreateArea:function(a){var b,c=this.constraints.dropArea.width;b=a?this.canvas.rect(0,0,c,this.canvas.height):this.canvas.rect(this.canvas.width-c,0,c,this.canvas.height),b.attr({stroke:"none",fill:"#f0ad4e",opacity:"0.3"}),b.toBack().animate({opacity:0},600,function(){this.animate({opacity:.3},600,function(){this.animate({opacity:0},600,function(){this.animate({opacity:.3},600,function(){})})})}),b.isInput=a,this.dropZoneRect=b},_drawScrollbars:function(){var a,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t=this.getEl(),u=t.node.getBBox(),v=b,w=8,x=2*w,y=w/3;a=this.horizontalBar,c=this.verticalBar,d=t.node.getCTM(),s=t.getTranslation(),e=this.canvas,f={width:e.width,height:e.height},g=f.width,h=f.height,u.l=u.x+d.e,u.r=u.l+u.width*d.a,u.t=u.y+d.f,u.b=u.t+u.height*d.d,a&&(a.remove(),this.horizontalBar=null),c&&(c.remove(),this.verticalBar=null),(u.l<0||u.r>g)&&(o=p=1,u.l<0&&(o=g/(g-u.l)),u.r>g&&(p=g/u.r),i=(u.l<0?g-g*o:0)+w/2,j=h-1.5*w,k=g*(p*o)-x,i>g-2*x&&(i=g-2*x),x>k&&(k=x),a=this.canvas.rect(i,j,k,w,y).attr({fill:v,stroke:"none"}),a.toFront(),this.horizontalBar=a),(u.t<0||u.b>h)&&(q=r=1,u.t<0&&(q=h/(h-u.t)),u.b>h&&(r=h/u.b),l=g-1.5*w,m=(u.t<0?h*(1-q):0)+w/2,n=h*(r*q)-x,m>h-2*x&&(m=h-2*x),x>n&&(n=x),c=this.canvas.rect(l,m,w,n,y).attr({fill:v,stroke:"none"}),c.toFront(),this.verticalBar=c)},_transformModel:function(a){var b=a.json||a;return _.forEach(b.inputs.properties,function(a,b){a.name=b,a.id=a.id||b}),_.forEach(b.outputs.properties,function(a,b){a.name=b,a.id=a.id||b}),b},_transformWorkflowModel:function(a){var b=a.json;return b},_getOffset:function(a){var b=document.body.getBoundingClientRect(),c=a.getBoundingClientRect(),d=c.top-b.top,e=c.left-b.left;return{top:d,left:e}},_getConnections:function(){return _.pluck(this.connections,"model")},_getNodes:function(){return _.clone(_.pluck(this.nodes,"model"),!0)},createConnection:function(a){var b,d,e=this;this.tempConnectionRefs&&(b=this.tempConnectionRefs.end,d=this.tempConnectionRefs.start,e.connections[a.id]=new c({model:a,canvas:e.canvas,parent:e.pipelineWrap,nodes:e.nodes,pipeline:e,input:b,output:d,element:e.$parent}),e.nodes[a.start_node].addConnection(e.connections[a.id]),e.nodes[a.end_node].addConnection(e.connections[a.id]),this.Event.trigger("pipeline:change"))},getEl:function(){return this.pipelineWrap},removeConnection:function(a){this.connections[a.id]&&(this.connections[a.id]=null,delete this.connections[a.id])},_zoomingFinish:function(){this._drawScrollbars(),this.model.display.canvas.zoom=this.currentScale},_parseTreeGraphModel:function(a){var b=this.model,c=250,d={},e=function(a,c,g){if(a.model.parent=0===c?!1:g.model.id,b.nodes.push(a.model),b.schemas[a.model.id]=a.model,d[c]="number"==typeof d[c]?d[c]+1:0,b.display.nodes[a.model.id]=b.display.nodes[a.model.id]||f(c,d[c]),g){var h={id:_.random(1e5,999999)+"",start_node:g.model.id,output_name:g.model.outputs[0].id,end_node:a.model.id,input_name:a.model.inputs[0].id};b.relations.push(h)}if("undefined"!=typeof a.children&&_.isArray(a.children)&&a.children.length>0){c++;var i=[];_.forEach(a.children,function(a){i.push(a.model.id)}),a.model.childrenList=i,_.forEach(a.children,function(b,d){e(b,c,a,d)})}},f=function(a,b,d){var e=c*a,f=b*c/2;return{x:e,y:f}};_.isArray(a)?_.forEach(a,function(a){e(a,0,!1,0)}):e(a,0,!1,0)},alignGraph:function(a,b){if(!this.treeGraph)return console.log("[Align Graph] Tree Graph must be enabled for alignment"),!1;"undefined"==typeof a||"number"==typeof a&&"object"==typeof a||console.log("[Align Graph] Gap is provided as "+typeof a+", and required type is number. Defaulting to 250");var c=this,d={x:250,y:250},e={x:80,y:80},f={},g=i.tsort(this.getConnections()).sorted;"undefined"!=typeof b&&"object"==typeof b&&_.assign(e,b),"object"==typeof a&&_.assign(d,a),"number"==typeof a&&(d.x=a,d.y=a);var h=function(a,b){var c=d.x*a,e=b*d.y/2;return{x:c,y:e}},j=function(a,b){var d=c.getNodeById(a),e=d.model;f[b]="number"==typeof f[b]?f[b]+1:0;var g=h(b,f[b]);e.x=g.x,e.y=g.y,d.el.translate(e.x,e.y),d.redrawConnections()},k=function(a,b){if(!_.isArray(b)||0===b.length)return!1;var d=a;_.forEach(b,function(a,b){var e=c.getNodeById(a);j(a,d),k(d+1,e.model.childrenList)})};_.forEach(g,function(a){var b=c.getNodeById(a);b.model.parent||(j(a,0),k(1,b.model.childrenList))}),this._move({x:e.x,y:e.y}),this.Event.trigger("nodes:align"),this.Event.trigger("pipeline:change")},initZoom:function(){return this._initZoomLevel(this.currentScale),this.currentScale},getConnections:function(){return this._getConnections()},getNodeById:function(a){return this.nodes[a]||a===!1||console.error("Node with id: "+a+" not found"),this.nodes[a]},removeNode:function(a,b){b=b||!1;var c=this;if("undefined"==typeof a)throw Error("Node ID must be supplied to remove node");var d=this.getNodeById(a),e=this.getNodeById(d.model.parent);"undefined"==typeof e||b||_.remove(e.model.childrenList,function(b){return b===a}),d.model.childrenList&&d.model.childrenList.length>0&&_.forEach(d.model.childrenList,function(a){"undefined"!=typeof a&&"undefined"!=typeof c.getNodeById(a)&&c.removeNode(a,!0)}),d.removeNode()},destroy:function(){var a=this,b=["connection:create","scrollbars:draw","node:add","node:deselect"];this.canvas=null,this.model=null,this.$parent.find("svg").remove(),_.each(this.connections,function(a){a.destroy()}),_.each(this.nodes,function(a){a.destroy()}),this.nodes=null,_.each(b,function(b){a.Event.unsubscribe(b)}),this.Event=null,this.values=null,this.exposed=null,delete this.values,delete this.exposed,$("body").off("mouseup")},connectNodes:function(a,b,c,d){var e=this.getNodeById(a).getFirstTerminal("output"),f=this.getNodeById(b).getFirstTerminal("input"),g={id:_.random(1e5,999999)+"",start_node:a,end_node:b,input_name:f.id,output_name:e.id,connection_name:c||!1,connection_class_name:d||!1};this.tempConnectionRefs={end:f,start:e},this.createConnection(g)},addNode:function(a,b,c,d,e){var f,g=_.clone(a,!0),h=b.x,i=b.y;c=c||!1,d=d||{},f=a.type&&"workflow"===a.type?this._transformWorkflowModel(a):this._transformModel(a);var j=this.getEl().getScale().x,k=this._getOffset(this.$parent[0]),l=h-k.left-this.pipelineWrap.getTranslation().x,m=i-k.top-this.pipelineWrap.getTranslation().y;c&&(l=h-this.pipelineWrap.getTranslation().x,m=i-this.pipelineWrap.getTranslation().y),f.x=l/j,f.y=m/j;var n=f.id||this._generateNodeId(f);return f.id=n,this.model.schemas[f.id]=g,this.Event.trigger("node:add",f,d),_.isFunction(e)&&e(n),n},adjustSize:function(){var a=this.$parent[0].offsetWidth-10,b=this.$parent[0].offsetHeight||this.$parent[0].parentNode.offsetHeight;return b>0&&(b-=10),0>a||0>b?!1:(this.canvas.setSize(a,b),this.rect.attr({width:a,height:b}),void this._drawScrollbars())},getJSON:function(){var a=this,b=_.clone(this.model,!0);return b.relations=this._getConnections(),b.nodes=this._getNodes(),b.display.nodes={},_.each(b.nodes,function(c){var d=c.id||c["@id"],e=a.getNodeById(d);b.display.nodes[d]={x:c.x,y:c.y,constraints:e.constraints,squareConstraints:e.squareConstraints,icons:e.icons},delete c.x,delete c.y}),b.display.canvas.x=this.getEl().getTranslation().x,b.display.canvas.y=this.getEl().getTranslation().y,b},getTreeJSON:function(){var a=this,b=[],c=this._getConnections(),d=i.tsort(c);if(d.errors.length>0)throw Error("There are some errors in graph: "+d.errors.toString());if(0===c.length)return this.getJSON();for(var e=function(a,b){_.forEach(a,function(a){f(a,b)})},f=function(b,c){var f=a.getNodeById(b),g={model:{},children:[]},h=f.model.childrenList;_.remove(d.sorted,function(a){return a===b}),g.model=f.model,"undefined"!=typeof h&&h.length>0&&(g.children=[],e(h,g.children)),0===g.children.length&&delete g.children,c.push(g)},g=function(a){f(a,b)};0!==d.sorted.length;)g(d.sorted[0]);return b},zoomIn:function(){var a=this.getEl(),b=a.getScale(),c=a.node.getBBox(),d=a.node.getCTM(),e=c,f=.05;return c.l=c.x+d.e,c.t=c.y+d.f,c.r=c.l+e.width*d.a,b.x<1.2&&b.y<1.2&&(this.currentScale+=f,a.scaleAtPoint(this.currentScale,{x:c.r-e.width/2,y:c.t-e.height/2}),this._zoomingFinish()),this.currentScale},zoomOut:function(){var a=this.getEl(),b=a.getScale(),c=a.node.getBBox(),d=a.node.getCTM(),e=c,f=.05;return c.l=c.x+d.e,c.t=c.y+d.f,c.r=c.l+e.width*d.a,b.x>.6&&b.y>.6&&(this.currentScale-=f,a.scaleAtPoint(this.currentScale,{x:c.r-e.width/2,y:c.t-e.height/2}),this._zoomingFinish()),this.currentScale}},e}(),h={objectPropExists:function(a){return"undefined"!=typeof a},checkObjectKeys:function(a){return this.objectPropExists(a)&&_.size(a)>0},getPropType:function(a){var b,c=typeof a;return b=c,"object"===c&&_.isArray(a)&&(b="array"),b},setConstraints:function(a,b){_.forEach(b,function(b,c){h.objectPropExists(b)&&("object"==h.getPropType(b)?_.forEach(b,function(b,d){"object"==typeof a[c]&&"undefined"!=typeof a[c][d]&&(a[c][d]=b)}):a[c]=b)})}},i={tsort:function(a){var b={},c=[],d={},e=[],f=function(a){this.id=a,this.afters=[]};return a.forEach(function(a){var c=a.start_node,d=a.end_node;b[c]||(b[c]=new f(c)),b[d]||(b[d]=new f(d)),b[c].afters.push(d)}),Object.keys(b).forEach(function g(a,f){var h=b[a],i=h.id;d[a]||(Array.isArray(f)||(f=[]),f.push(i),d[a]=!0,h.afters.forEach(function(a){return f.indexOf(a)>=0?(e.push("Closed chain : "+a+" is in "+i),!1):void g(a.toString(),f.map(function(a){return a}))}),c.unshift(i))}),{sorted:c,errors:e}}};return g});